name: ci

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Validate install script syntax
        run: bash -n install.sh

      - name: Validate JSON config files
        run: |
          node -e "JSON.parse(require('fs').readFileSync('opencode-profile/opencode.json','utf8'))"
          node -e "JSON.parse(require('fs').readFileSync('opencode-profile/oh-my-opencode.json','utf8'))"
          node -e "JSON.parse(require('fs').readFileSync('opencode-profile/package.json','utf8'))"

      - name: Validate profile dependencies
        run: npm --prefix opencode-profile ci --omit=dev

      - name: Validate skills have SKILL.md
        run: |
          errors=0
          for dir in opencode-profile/skills/*/; do
            if [[ ! -f "${dir}SKILL.md" ]]; then
              echo "ERROR: Missing SKILL.md in ${dir}"
              errors=$((errors + 1))
            fi
          done
          echo "Skills validated: $(ls -1d opencode-profile/skills/*/ | wc -l)"
          echo "Commands found: $(ls -1 opencode-profile/commands/*.md | wc -l)"
          exit $errors

      - name: Validate command frontmatter
        run: |
          for f in opencode-profile/commands/*.md; do
            if ! head -1 "$f" | grep -q '^---$'; then
              echo "ERROR: Missing frontmatter in $f"
              exit 1
            fi
          done
          echo "All commands have valid frontmatter"

      - name: Smoke test install script
        run: |
          bash install.sh --help
          echo "Install script --help works"
